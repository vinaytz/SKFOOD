<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home | Premium Shop</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-black min-h-screen text-gray-100">
  <nav class="bg-gray-900 shadow flex items-center justify-between px-8 py-4">
    <div class="text-xl font-bold text-blue-400">Premium Shop</div>
    <div class="flex items-center gap-4">
      <span id="userName" class="font-semibold text-gray-200"></span>
      <img id="userPic" src="" alt="Profile" class="w-10 h-10 rounded-full border border-gray-700">
      <a href="my_orders.html" class="text-blue-400 hover:underline font-semibold">My Orders</a>
      <button id="logoutBtn" class="bg-red-700 text-white px-3 py-1 rounded hover:bg-red-800">Logout</button>
    </div>
  </nav>
  <main class="p-8">
    <h2 class="text-2xl font-bold mb-6 text-gray-100">Products</h2>
    <div id="products" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
  </main>
  <!-- <script src="https://checkout.razorpay.com/v1/checkout.js"></script> -->
  <script>

    // Helper to get cookie
    
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Redirect if not logged in
    const token = getCookie("token")
    console.log("tttt" ,token)
    if (!token) window.location.href = 'login.html';

    // //our Vtz style Middleware
    // fetch("http://localhost:6363/api/auth/checkAuth", {
    //   headers: { Authorization: `Bearer ${token}` }
    // }).then(async res=>{
    //   if(!res.ok){
    //     localStorage.clear()
    //     window.location.href = 'login.html';}
    // })
    
    // Fetch user profile
    fetch('http://localhost:6363/api/userAuth/profile',{
      method:"GET",
      headers: {'Authorization': `Bearer ${token}`},
      credentials:"include"}
    )
      .then(async res => {
        if (!res.ok) {
          const error = await res.json();
          console.error('Profile fetch error:', error);
          return;
        }
        return res.json();
      })
      .then(user => {
        if (!user) return;
        console.log(user.picture)
        document.getElementById('userName').textContent = user.name;
        document.getElementById('userPic').src = user.picture
      });
    // Logout
    document.getElementById('logoutBtn').onclick = function() {
      document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 UTC;';
      window.location.href = 'login.html';
    };
   
    // Sample products for demonstration
    const products = [
      {
        id: 'book1',
        name: 'The Great Book',
        description: 'A must-read for every book lover.',
        price: 499,
        image: 'https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=400&q=80'
      },
      {
        id: 'cloth1',
        name: 'Premium T-Shirt',
        description: 'Comfortable and stylish cotton t-shirt.',
        price: 799,
        image: 'https://images.unsplash.com/photo-1512436991641-6745cdb1723f?auto=format&fit=crop&w=400&q=80'
      },
      {
        id: 'laptop1',
        name: 'Ultra Laptop',
        description: 'High performance laptop for professionals.',
        price: 59999,
        image: 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=400&q=80'
      },
      {
        id: 'phone1',
        name: 'Smartphone Pro',
        description: 'Latest smartphone with advanced features.',
        price: 29999,
        image: 'https://images.unsplash.com/photo-1511707171634-5f897ff02aa9?auto=format&fit=crop&w=400&q=80'
      },
      {
        id: 'headphone1',
        name: 'Wireless Headphones',
        description: 'Noise cancelling wireless headphones.',
        price: 3999,
        image: 'https://images.unsplash.com/photo-1511367461989-f85a21fda167?auto=format&fit=crop&w=400&q=80'
      }
    ];
    const container = document.getElementById('products');
    container.innerHTML = '';
    products.forEach(product => {
      const card = document.createElement('div');
      card.className = 'bg-gray-800 rounded-xl shadow p-6 flex flex-col items-center border border-gray-700';
      card.innerHTML = `
        <img src="${product.image}" alt="${product.name}" class="w-24 h-24 object-cover mb-4 rounded border border-gray-700">
        <h3 class="text-lg font-bold mb-2 text-gray-100">${product.name}</h3>
        <p class="text-gray-400 mb-2">${product.description}</p>
        <div class="text-blue-400 font-bold text-xl mb-4">â‚¹${product.price}</div>
        <button class="buyBtn bg-green-700 text-white px-4 py-2 rounded hover:bg-green-800 font-semibold"data-id="${product.id}" 
data-description="${product.description}"
 data-price="${product.price}" data-image="${product.image}" data-name="${product.name}">Buy Now</button>
      `;
      container.appendChild(card);
    });
        // Attach Razorpay handler
        document.querySelectorAll('.buyBtn').forEach(btn => {
          btn.onclick = async function() {
            const productId = this.getAttribute('data-id'); 
            const productName = this.getAttribute('data-name');
            const productImage = this.getAttribute('data-image');
            const productDescription = this.getAttribute('data-description');
            const productPrice = this.getAttribute('data-price');
            // Create Razorpay order
            const res = await fetch('http://localhost:6363/api/payment/razorpay/order', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`
              },
              body: JSON.stringify({ amount: productPrice})
            });
            const order = await res.json();
            console.log(order)
            const options = {
              key: "rzp_test_RKS5Z9p2Koz1gc",
              amount: order.amount,
              currency: 'INR',
              name: 'Premium Shop',
              description: productName,
              order_id: order.id,
              handler: async function (response) {
                // Save order in backend
                await fetch('http://localhost:6363/api/payment/razorpay/verify', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`
                  },
                  body: JSON.stringify({
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_signature: response.razorpay_signature,
                    productId,
                    productName,
                    productImage,
                    productDescription,
                    productPrice
                  })
                });
                window.location.href = 'my_orders.html';
              },
              prefill: {
                name: document.getElementById('userName').textContent,
                email: '', // You can fetch user email if needed
              },
              theme: { color: '#2563eb' }
            };
            const rzp = new Razorpay(options);
            rzp.open();
          };
        });
  </script>
</body>
</html>
